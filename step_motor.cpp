#include "step_motor.h"
#include "drv8711.h"
#include "QDebug"
STEP_MOTOR::STEP_MOTOR()
{
    CTRL_REG.DTIME     = (DRV8711_Registrs[0] & (~DRV8711_CTRL_DTIME_MASK))     >> DRV8711_CTRL_DTIME_POS;
    CTRL_REG.ISGAIN    = (DRV8711_Registrs[0] & (~DRV8711_CTRL_ISGAIN_MASK))    >> DRV8711_CTRL_ISGAIN_POS;
    CTRL_REG.EXSTALL   = (DRV8711_Registrs[0] & (~DRV8711_CTRL_EXSTALL_MASK))   >> DRV8711_CTRL_EXSTALL_POS;
    CTRL_REG.MODE      = (DRV8711_Registrs[0] & (~DRV8711_CTRL_MODE_MASK))      >> DRV8711_CTRL_MODE_POS;
    CTRL_REG.RSTEP     = (DRV8711_Registrs[0] & (~DRV8711_CTRL_RSTEP_MASK))     >> DRV8711_CTRL_RSTEP_POS;
    CTRL_REG.RDIR      = (DRV8711_Registrs[0] & (~DRV8711_CTRL_RDIR_MASK))      >> DRV8711_CTRL_RDIR_POS;
    CTRL_REG.ENBL      = (DRV8711_Registrs[0] & (~DRV8711_CTRL_ENBL_MASK))      >> DRV8711_CTRL_ENBL_POS;
    TORQUE_REG.SIMPLTH = (DRV8711_Registrs[1] & (~DRV8711_TORQUE_SIMPLTH_MASK)) >> DRV8711_TORQUE_SIMPLTH_POS;
    TORQUE_REG.TORQUE  = (DRV8711_Registrs[1] & (~DRV8711_TORQUE_TORQUE_MASK))  >> DRV8711_TORQUE_TORQUE_POS;
    OFF_REG.TOFF       = (DRV8711_Registrs[2] & (~DRV8711_OFF_TOFF_MASK))       >> DRV8711_OFF_TOFF_POS;
    OFF_REG.PWMMODE    = (DRV8711_Registrs[2] & (~DRV8711_OFF_PWMMODE_MASK))    >> DRV8711_OFF_PWMMODE_POS;
    BLANK_REG.ABT      = (DRV8711_Registrs[3] & (~DRV8711_BLANK_ABT_MASK))      >> DRV8711_BLANK_ABT_POS;
    BLANK_REG.TBLANK   = (DRV8711_Registrs[3] & (~DRV8711_BLANK_TBLANK_MASK))   >> DRV8711_BLANK_TBLANK_POS;
    DECAY_REG.DECMOD   = (DRV8711_Registrs[4] & (~DRV8711_DECAY_DECMOD_MASK))   >> DRV8711_DECAY_DECMOD_POS;
    DECAY_REG.TDECAY   = (DRV8711_Registrs[4] & (~DRV8711_DECAY_TDECAY_MASK))   >> DRV8711_DECAY_TDECAY_POS;
    STALL_REG.VDIV     = (DRV8711_Registrs[5] & (~DRV8711_STALL_VDIV_MASK))     >> DRV8711_STALL_VDIV_POS;
    STALL_REG.SDCNT    = (DRV8711_Registrs[5] & (~DRV8711_STALL_SDCNT_MASK))    >> DRV8711_STALL_SDCNT_POS;
    STALL_REG.SDTHR    = (DRV8711_Registrs[5] & (~DRV8711_STALL_SDTHR_MASK))    >> DRV8711_STALL_SDTHR_POS;
    DRIVE_REG.IDRIVEP  = (DRV8711_Registrs[6] & (~DRV8711_DRIVE_IDRIVEP_MASK))  >> DRV8711_DRIVE_IDRIVEP_POS;
    DRIVE_REG.IDRIVEN  = (DRV8711_Registrs[6] & (~DRV8711_DRIVE_IDRIVEN_MASK))  >> DRV8711_DRIVE_IDRIVEN_POS;
    DRIVE_REG.TDRIVEP  = (DRV8711_Registrs[6] & (~DRV8711_DRIVE_TDRIVEP_MASK))  >> DRV8711_DRIVE_TDRIVEP_POS;
    DRIVE_REG.TDRIVEN  = (DRV8711_Registrs[6] & (~DRV8711_DRIVE_TDRIVEN_MASK))  >> DRV8711_DRIVE_TDRIVEN_POS;
    DRIVE_REG.OCPDEG   = (DRV8711_Registrs[6] & (~DRV8711_DRIVE_OCPDEG_MASK))   >> DRV8711_DRIVE_OCPDEG_POS;
    DRIVE_REG.OCPTH    = (DRV8711_Registrs[6] & (~DRV8711_DRIVE_OCPTH_MASK))    >> DRV8711_DRIVE_OCPTH_POS;
    STATUS_REG.OTS     = (DRV8711_Registrs[7] & (~DRV8711_STATUS_OTS_MASK))     >> DRV8711_STATUS_OTS_POS;
    STATUS_REG.AOCP    = (DRV8711_Registrs[7] & (~DRV8711_STATUS_AOCP_MASK))    >> DRV8711_STATUS_AOCP_POS;
    STATUS_REG.BOCP    = (DRV8711_Registrs[7] & (~DRV8711_STATUS_BOCP_MASK))    >> DRV8711_STATUS_BOCP_POS;
    STATUS_REG.APDF    = (DRV8711_Registrs[7] & (~DRV8711_STATUS_APDF_MASK))    >> DRV8711_STATUS_APDF_POS;
    STATUS_REG.BPDF    = (DRV8711_Registrs[7] & (~DRV8711_STATUS_BPDF_MASK))    >> DRV8711_STATUS_BPDF_POS;
    STATUS_REG.UVLO    = (DRV8711_Registrs[7] & (~DRV8711_STATUS_UVLO_MASK))    >> DRV8711_STATUS_UVLO_POS;
    STATUS_REG.STD     = (DRV8711_Registrs[7] & (~DRV8711_STATUS_STD_MASK))     >> DRV8711_STATUS_STD_POS;
    STATUS_REG.STDLAT  = (DRV8711_Registrs[7] & (~DRV8711_STATUS_STDLAT_MASK))  >> DRV8711_STATUS_STDLAT_POS;

    //STATUS_REG;
}
quint16 STEP_MOTOR::GetREG(quint8 addr)
{
    return (DRV8711_Registrs[addr]);
}

void STEP_MOTOR::SetREG(quint8 addr, quint16 data)
{
    DRV8711_Registrs[addr]=data;
    switch (addr)
    {
    case DRV8711_CTRL:
         CTRL_REG.DTIME     = (DRV8711_Registrs[DRV8711_CTRL] & (~DRV8711_CTRL_DTIME_MASK))     >> DRV8711_CTRL_DTIME_POS;
         CTRL_REG.ISGAIN    = (DRV8711_Registrs[DRV8711_CTRL] & (~DRV8711_CTRL_ISGAIN_MASK))    >> DRV8711_CTRL_ISGAIN_POS;
         CTRL_REG.EXSTALL   = (DRV8711_Registrs[DRV8711_CTRL] & (~DRV8711_CTRL_EXSTALL_MASK))   >> DRV8711_CTRL_EXSTALL_POS;
         CTRL_REG.MODE      = (DRV8711_Registrs[DRV8711_CTRL] & (~DRV8711_CTRL_MODE_MASK))      >> DRV8711_CTRL_MODE_POS;
         CTRL_REG.RSTEP     = (DRV8711_Registrs[DRV8711_CTRL] & (~DRV8711_CTRL_RSTEP_MASK))     >> DRV8711_CTRL_RSTEP_POS;
         CTRL_REG.RDIR      = (DRV8711_Registrs[DRV8711_CTRL] & (~DRV8711_CTRL_RDIR_MASK))      >> DRV8711_CTRL_RDIR_POS;
         CTRL_REG.ENBL      = (DRV8711_Registrs[DRV8711_CTRL] & (~DRV8711_CTRL_ENBL_MASK))      >> DRV8711_CTRL_ENBL_POS;
         break;

   case DRV8711_TORQUE:
     {
        TORQUE_REG.SIMPLTH = (DRV8711_Registrs[DRV8711_TORQUE] & (~DRV8711_TORQUE_SIMPLTH_MASK)) >> DRV8711_TORQUE_SIMPLTH_POS;
        TORQUE_REG.TORQUE  = (DRV8711_Registrs[DRV8711_TORQUE] & (~DRV8711_TORQUE_TORQUE_MASK))  >> DRV8711_TORQUE_TORQUE_POS;
        break;
     }
   case DRV8711_OFF:
     {
        OFF_REG.TOFF       = (DRV8711_Registrs[DRV8711_OFF] & (~DRV8711_OFF_TOFF_MASK))       >> DRV8711_OFF_TOFF_POS;
        OFF_REG.PWMMODE    = (DRV8711_Registrs[DRV8711_OFF] & (~DRV8711_OFF_PWMMODE_MASK))    >> DRV8711_OFF_PWMMODE_POS;
        break;
     }
   case DRV8711_BLANK:
     {
        BLANK_REG.ABT      = (DRV8711_Registrs[DRV8711_BLANK] & (~DRV8711_BLANK_ABT_MASK))      >> DRV8711_BLANK_ABT_POS;
        BLANK_REG.TBLANK   = (DRV8711_Registrs[DRV8711_BLANK] & (~DRV8711_BLANK_TBLANK_MASK))   >> DRV8711_BLANK_TBLANK_POS;
        break;
     }
   case DRV8711_DECAY:
     {
        DECAY_REG.DECMOD   = (DRV8711_Registrs[DRV8711_DECAY] & (~DRV8711_DECAY_DECMOD_MASK))   >> DRV8711_DECAY_DECMOD_POS;
        DECAY_REG.TDECAY   = (DRV8711_Registrs[DRV8711_DECAY] & (~DRV8711_DECAY_TDECAY_MASK))   >> DRV8711_DECAY_TDECAY_POS;
        break;
     }
   case DRV8711_STALL:
     {
        STALL_REG.VDIV     = (DRV8711_Registrs[DRV8711_STALL] & (~DRV8711_STALL_VDIV_MASK))     >> DRV8711_STALL_VDIV_POS;
        STALL_REG.SDCNT    = (DRV8711_Registrs[DRV8711_STALL] & (~DRV8711_STALL_SDCNT_MASK))    >> DRV8711_STALL_SDCNT_POS;
        STALL_REG.SDTHR    = (DRV8711_Registrs[DRV8711_STALL] & (~DRV8711_STALL_SDTHR_MASK))    >> DRV8711_STALL_SDTHR_POS;
        break;
     }
   case DRV8711_DRIVE:
     {
        DRIVE_REG.IDRIVEP  = (DRV8711_Registrs[DRV8711_DRIVE] & (~DRV8711_DRIVE_IDRIVEP_MASK))  >> DRV8711_DRIVE_IDRIVEP_POS;
        DRIVE_REG.IDRIVEN  = (DRV8711_Registrs[DRV8711_DRIVE] & (~DRV8711_DRIVE_IDRIVEN_MASK))  >> DRV8711_DRIVE_IDRIVEN_POS;
        DRIVE_REG.TDRIVEP  = (DRV8711_Registrs[DRV8711_DRIVE] & (~DRV8711_DRIVE_TDRIVEP_MASK))  >> DRV8711_DRIVE_TDRIVEP_POS;
        DRIVE_REG.TDRIVEN  = (DRV8711_Registrs[DRV8711_DRIVE] & (~DRV8711_DRIVE_TDRIVEN_MASK))  >> DRV8711_DRIVE_TDRIVEN_POS;
        DRIVE_REG.OCPDEG   = (DRV8711_Registrs[DRV8711_DRIVE] & (~DRV8711_DRIVE_OCPDEG_MASK))   >> DRV8711_DRIVE_OCPDEG_POS;
        DRIVE_REG.OCPTH    = (DRV8711_Registrs[DRV8711_DRIVE] & (~DRV8711_DRIVE_OCPTH_MASK))    >> DRV8711_DRIVE_OCPTH_POS;
        break;
     }
   case DRV8711_STATUS:
     {
        STATUS_REG.OTS     = (DRV8711_Registrs[DRV8711_STATUS] & (~DRV8711_STATUS_OTS_MASK))     >> DRV8711_STATUS_OTS_POS;
        STATUS_REG.AOCP    = (DRV8711_Registrs[DRV8711_STATUS] & (~DRV8711_STATUS_AOCP_MASK))    >> DRV8711_STATUS_AOCP_POS;
        STATUS_REG.BOCP    = (DRV8711_Registrs[DRV8711_STATUS] & (~DRV8711_STATUS_BOCP_MASK))    >> DRV8711_STATUS_BOCP_POS;
        STATUS_REG.APDF    = (DRV8711_Registrs[DRV8711_STATUS] & (~DRV8711_STATUS_APDF_MASK))    >> DRV8711_STATUS_APDF_POS;
        STATUS_REG.BPDF    = (DRV8711_Registrs[DRV8711_STATUS] & (~DRV8711_STATUS_BPDF_MASK))    >> DRV8711_STATUS_BPDF_POS;
        STATUS_REG.UVLO    = (DRV8711_Registrs[DRV8711_STATUS] & (~DRV8711_STATUS_UVLO_MASK))    >> DRV8711_STATUS_UVLO_POS;
        STATUS_REG.STD     = (DRV8711_Registrs[DRV8711_STATUS] & (~DRV8711_STATUS_STD_MASK))     >> DRV8711_STATUS_STD_POS;
        STATUS_REG.STDLAT  = (DRV8711_Registrs[DRV8711_STATUS] & (~DRV8711_STATUS_STDLAT_MASK))  >> DRV8711_STATUS_STDLAT_POS;
        break;
     }
    }
    emit UpdateRegister(addr);
}

void STEP_MOTOR::update_single(int addr)
{
    switch (addr)
      {
         case DRV8711_CTRL:
           DRV8711_Registrs[addr] &=(DRV8711_CTRL_DTIME_MASK);
           DRV8711_Registrs[addr] |=(CTRL_REG.DTIME << DRV8711_CTRL_DTIME_POS );
           DRV8711_Registrs[addr] &=(DRV8711_CTRL_ISGAIN_MASK);
           DRV8711_Registrs[addr] |=(CTRL_REG.ISGAIN << DRV8711_CTRL_ISGAIN_POS );
           DRV8711_Registrs[addr] &=(DRV8711_CTRL_EXSTALL_MASK);
           DRV8711_Registrs[addr] |=(CTRL_REG.EXSTALL << DRV8711_CTRL_EXSTALL_POS );
           DRV8711_Registrs[addr] &=(DRV8711_CTRL_MODE_MASK);
           DRV8711_Registrs[addr] |=(CTRL_REG.MODE << DRV8711_CTRL_MODE_POS );
           DRV8711_Registrs[addr] &=(DRV8711_CTRL_RSTEP_MASK);
           DRV8711_Registrs[addr] |=(CTRL_REG.RSTEP << DRV8711_CTRL_RSTEP_POS );
           DRV8711_Registrs[addr] &=(DRV8711_CTRL_RDIR_MASK);
           DRV8711_Registrs[addr] |=(CTRL_REG.RDIR << DRV8711_CTRL_RDIR_POS );
           DRV8711_Registrs[addr] &=(DRV8711_CTRL_ENBL_MASK);
           DRV8711_Registrs[addr] |=(CTRL_REG.ENBL << DRV8711_CTRL_ENBL_POS );
           break;

        case DRV8711_TORQUE:
          {
            DRV8711_Registrs[addr] &=(DRV8711_TORQUE_SIMPLTH_MASK);
            DRV8711_Registrs[addr] |=(TORQUE_REG.SIMPLTH << DRV8711_TORQUE_SIMPLTH_POS );
            DRV8711_Registrs[addr] &=(DRV8711_TORQUE_TORQUE_MASK);
            DRV8711_Registrs[addr] |=(TORQUE_REG.TORQUE << DRV8711_TORQUE_TORQUE_POS );
            break;
          }
        case DRV8711_OFF:
          {
            DRV8711_Registrs[addr] &=(DRV8711_OFF_TOFF_MASK);
            DRV8711_Registrs[addr] |=(OFF_REG.TOFF << DRV8711_OFF_TOFF_POS);
            DRV8711_Registrs[addr] &=(DRV8711_OFF_PWMMODE_MASK);
            DRV8711_Registrs[addr] |=(OFF_REG.PWMMODE << DRV8711_OFF_PWMMODE_POS);
            break;
          }
        case DRV8711_BLANK:
          {
            DRV8711_Registrs[addr] &=(DRV8711_BLANK_ABT_MASK);
            DRV8711_Registrs[addr] |=(BLANK_REG.ABT << DRV8711_BLANK_ABT_POS);
            DRV8711_Registrs[addr] &=(DRV8711_BLANK_TBLANK_MASK);
            DRV8711_Registrs[addr] |=(BLANK_REG.TBLANK << DRV8711_BLANK_TBLANK_POS);
            break;
          }
        case DRV8711_DECAY:
          {
            DRV8711_Registrs[addr] &=(DRV8711_DECAY_DECMOD_MASK);
            DRV8711_Registrs[addr] |=(DECAY_REG.DECMOD << DRV8711_DECAY_DECMOD_POS);
            DRV8711_Registrs[addr] &=(DRV8711_DECAY_TDECAY_MASK);
            DRV8711_Registrs[addr] |=(DECAY_REG.TDECAY << DRV8711_DECAY_TDECAY_POS);
            break;
          }
        case DRV8711_STALL:
          {
            DRV8711_Registrs[addr] &=(DRV8711_STALL_SDCNT_MASK);
            DRV8711_Registrs[addr] |=(STALL_REG.SDCNT << DRV8711_STALL_SDCNT_POS);
            DRV8711_Registrs[addr] &=(DRV8711_STALL_SDTHR_MASK);
            DRV8711_Registrs[addr] |=(STALL_REG.SDTHR << DRV8711_STALL_SDTHR_POS);
            DRV8711_Registrs[addr] &=(DRV8711_STALL_VDIV_MASK);
            DRV8711_Registrs[addr] |=(STALL_REG.VDIV << DRV8711_STALL_VDIV_POS);
            break;
          }
        case DRV8711_DRIVE:
          {
            DRV8711_Registrs[addr] &=(DRV8711_DRIVE_IDRIVEN_MASK);
            DRV8711_Registrs[addr] |=(DRIVE_REG.IDRIVEN << DRV8711_DRIVE_IDRIVEN_POS);
            DRV8711_Registrs[addr] &=(DRV8711_DRIVE_IDRIVEP_MASK);
            DRV8711_Registrs[addr] |=(DRIVE_REG.IDRIVEP << DRV8711_DRIVE_IDRIVEP_POS);
            DRV8711_Registrs[addr] &=(DRV8711_DRIVE_OCPDEG_MASK);
            DRV8711_Registrs[addr] |=(DRIVE_REG.OCPDEG << DRV8711_DRIVE_OCPDEG_POS);
            DRV8711_Registrs[addr] &=(DRV8711_DRIVE_OCPTH_MASK);
            DRV8711_Registrs[addr] |=(DRIVE_REG.OCPTH << DRV8711_DRIVE_OCPTH_POS);
            DRV8711_Registrs[addr] &=(DRV8711_DRIVE_TDRIVEN_MASK);
            DRV8711_Registrs[addr] |=(DRIVE_REG.TDRIVEN << DRV8711_DRIVE_TDRIVEN_POS);
            DRV8711_Registrs[addr] &=(DRV8711_DRIVE_TDRIVEP_MASK);
            DRV8711_Registrs[addr] |=(DRIVE_REG.TDRIVEP << DRV8711_DRIVE_TDRIVEP_POS);
            break;
          }
        case DRV8711_STATUS:
          {
            DRV8711_Registrs[addr] &=(DRV8711_STATUS_OTS_MASK);
            DRV8711_Registrs[addr] |=(STATUS_REG.OTS << DRV8711_STATUS_OTS_POS);
            DRV8711_Registrs[addr] &=(DRV8711_STATUS_AOCP_MASK);
            DRV8711_Registrs[addr] |=(STATUS_REG.AOCP << DRV8711_STATUS_AOCP_POS);
            DRV8711_Registrs[addr] &=(DRV8711_STATUS_BOCP_MASK);
            DRV8711_Registrs[addr] |=(STATUS_REG.BOCP << DRV8711_STATUS_BOCP_POS);
            DRV8711_Registrs[addr] &=(DRV8711_STATUS_APDF_MASK);
            DRV8711_Registrs[addr] |=(STATUS_REG.APDF << DRV8711_STATUS_APDF_POS);
            DRV8711_Registrs[addr] &=(DRV8711_STATUS_BPDF_MASK);
            DRV8711_Registrs[addr] |=(STATUS_REG.BPDF << DRV8711_STATUS_BPDF_POS);
            DRV8711_Registrs[addr] &=(DRV8711_STATUS_UVLO_MASK);
            DRV8711_Registrs[addr] |=(STATUS_REG.UVLO << DRV8711_STATUS_UVLO_POS);
            DRV8711_Registrs[addr] &=(DRV8711_STATUS_STD_MASK);
            DRV8711_Registrs[addr] |=(STATUS_REG.STD << DRV8711_STATUS_STD_POS);
            DRV8711_Registrs[addr] &=(DRV8711_STATUS_STDLAT_MASK);
            DRV8711_Registrs[addr] |=(STATUS_REG.STDLAT << DRV8711_STATUS_STDLAT_POS);
            break;
          }
      }
    emit UpdateRegister(addr);
}


